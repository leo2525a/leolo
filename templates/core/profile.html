{% extends 'core/base.html' %}
{% load static %}

{% block title %}員工儀表板{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">儀表板</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">歡迎回來, {{ user.get_full_name|default:user.username }}！</li>
    </ol>

    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                        <div class="text-end">
                            <div class="fs-3">{{ total_employees }}</div>
                            <div>總在職員工</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-warning text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <i class="fas fa-user-clock fa-2x"></i>
                        </div>
                        <div class="text-end">
                            <div class="fs-3">{{ on_leave_today }}</div>
                            <div>今日休假人數</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <i class="fas fa-hourglass-half fa-2x"></i>
                        </div>
                        <div class="text-end">
                            <div class="fs-3">{{ pending_requests }}</div>
                            <div>我的待處理請求</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-danger text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <i class="fas fa-briefcase fa-2x"></i>
                        </div>
                        <div class="text-end">
                            <div class="fs-3">{{ open_positions }}</div>
                            <div>開放中職缺</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-history me-1"></i>
                    我最近的休假申請
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>申請類型</th>
                                <th>開始時間</th>
                                <th>結束時間</th>
                                <th>狀態</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for req in leave_requests %}
                            <tr>
                                <td>{{ req.leave_type.name }}</td>
                                <td>{{ req.start_datetime|date:"Y-m-d H:i" }}</td>
                                <td>{{ req.end_datetime|date:"Y-m-d H:i" }}</td>
                                <td>
                                    {% if req.status == 'Approved' %}
                                        <span class="badge bg-success">已批准</span>
                                    {% elif req.status == 'Rejected' %}
                                        <span class="badge bg-danger">已拒絕</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">待處理</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">沒有休假申請記錄。</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-1"></i>
                    假期餘額概覽 (小時)
                </div>
                <div class="card-body">
                    <canvas id="leaveBalanceChart" width="100%" height="100"></canvas>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-bullhorn me-1"></i>
                    最新公告
                </div>
                <div class="card-body">
                    {% for announcement in latest_announcements %}
                    <div class="mb-3">
                        <h6 class="mb-1">{{ announcement.title }}</h6>
                        <small class="text-muted">{{ announcement.created_at|date:"Y-m-d" }}</small>
                        <p class="mb-0">{{ announcement.content|truncatewords:20 }}</p>
                    </div>
                    {% empty %}
                    <p class="text-center">目前沒有公告。</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{{ leave_balances_data|json_script:"leave-balance-data" }}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. 獲取從 Django 傳來的數據
    const leaveBalanceData = JSON.parse(document.getElementById('leave-balance-data').textContent);

    // 2. 準備圖表所需的標籤和數據
    const labels = leaveBalanceData.map(item => item.name);
    const remainingHours = leaveBalanceData.map(item => item.remaining);
    const usedHours = leaveBalanceData.map(item => item.used);

    // 3. 獲取 Canvas 元素
    const ctx = document.getElementById('leaveBalanceChart').getContext('2d');

    // 4. 建立並設定甜甜圈圖
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                label: '已使用 (小時)',
                data: usedHours,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(153, 102, 255, 0.5)',
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                ],
                borderWidth: 1
            },
            {
                label: '剩餘 (小時)',
                data: remainingHours,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += context.parsed + ' 小時';
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}